<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ripping it up!</title>
    <meta property="og:description" content="Create a deck.gl layer as an overlay from a REST API." />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
      }
      /* Deck.gl layer is added as an overlay, popup needs to be displayed over it */
      .maplibregl-popup {
        z-index: 2;
      }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const url = 'https://maps.clockworkmicro.com/streets/v1/style?x-api-key=';
        const apiKey = 'Qp3vRduQ1UaS9hFgUzhuE6k7nzvzGuQOa8mYDp4Z'; //note: I had to generate this api key at https://maps.clockworkmicro.com  LOGIN details, alistair.peat@gmail.com, Boobsrgood1!

        const map = new maplibregl.Map({
            container: 'map',
            style: url + apiKey,
            center: [-4.7556, 54.3229],
            zoom: 5.25,
        });
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        async function getBMUs(){
            response = await fetch(new Request('./testImportJSON.json'), {
                mode: 'no-cors'
            });

            let bmus = await response.json();
            // console.log(bmus);
            return bmus;
        }

        map.on('load', async () => {
          // Fetch the data
          bmusReal = getBMUs();
          console.log(bmusReal);

          const layer = new deck.ScatterplotLayer({
              id: 'scatterplot-layer',
              data: bmusReal,
              pickable: true,
              opacity: 0.7,
              stroked: true,
              filled: true,
              radiusMinPixels: 5,
              radiusMaxPixels: 10,
              lineWidthMinPixels: 5,
              // Using appropriate fields for coordinates from the dataset
              //getPosition: (d) => [d.geo_point_2d.lon, d.geo_point_2d.lat],
              getPosition: (d) => [d.lon, d.lat],
              getFillColor: (d) => [14, 16, 255],
              getLineColor: (d) => [14, 16, 255],
              onClick: (info) => {
                  const {coordinate, object} = info;
                  const description = `<p>${object.nom_carto || 'Unknown'}</p>`;

                  new maplibregl.Popup()
                      .setLngLat(coordinate)
                      .setHTML(description)
                      .addTo(map);
              },
              
          });//new deck.ScatterplotLayer

          

          // Create the overlay
          const overlay = new deck.MapboxOverlay({
              layers: [layer],
          });
          map.addControl(overlay);
      });
    

        
    </script>
</body>
</html>