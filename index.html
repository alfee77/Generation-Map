<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ripping it up!</title>
    <meta property="og:description" content="Create a deck.gl layer as an overlay from a REST API." />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      html,
      body,
      #map {
        height: 100%;
        color: rgb(0, 0, 0)
      }
      /* Deck.gl layer is added as an overlay, popup needs to be displayed over it */
      .maplibregl-popup {
        z-index: 2;
      }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const url = 'https://maps.clockworkmicro.com/streets/v1/style?x-api-key=';
        const apiKey = 'Qp3vRduQ1UaS9hFgUzhuE6k7nzvzGuQOa8mYDp4Z'; //note: I had to generate this api key at https://maps.clockworkmicro.com  LOGIN details, alistair.peat@gmail.com, Boobsrgood1!

        const map = new maplibregl.Map({
            container: 'map',
            style: url + apiKey,
            center: [-4.7556, 54.3229],
            zoom: 5,
        });
        
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        
        
        async function getBMUs(){
            response = await fetch(new Request('./testImportJSON.json'), {
                mode: 'no-cors'
            });

            let bmus = await response.json();
            // console.log(bmus);
            return bmus;
        }

        

        
        
            

        map.on('load', async () => {

          //Some pretty colours to colour code generation types
          const colorPalette = {
            "wind": [68, 212, 68],
            "biomass": [255, 179, 153],
            "solar": [255, 51, 255],
            "nuclear": [255, 255, 0],
            "naturalGas": [0, 179, 230],
            "pumpedHydro": [46, 139, 87],
            "hydro": [46, 139, 87],
            "coal": [255, 255, 255],
            "dieselgasOil": [128, 128, 128],
            "sourGas": [179, 77, 77],
          }

          // Fetch the data
          bmusReal = getBMUs();
          const layer = new deck.ScatterplotLayer(
            {
              id: 'scatterplot-layer',
              data: bmusReal,
              pickable: true,
              opacity: 0.1,
              stroked: true,
              filled: true,
              // radiusMinPixels: 10,
              // radiusMaxPixels: 10,

              lineWidthMinPixels: 0.5,
              // Using appropriate fields for coordinates from the dataset
              getPosition: (d) => [d.lon, d.lat],
              getFillColor: (d) => {
                switch (d.primaryFuel) {
                  case "Wind":
                    return colorPalette.wind;
                    break;
                  case "Nuclear":
                    return colorPalette.nuclear;
                    break;
                  case "Natural Gas":
                    return colorPalette.naturalGas;
                    break;
                  case "Diesel/Gas Oil":
                    return colorPalette.dieselgasOil;
                    break;
                  case "Pumped hydro":
                    return colorPalette.pumpedHydro;
                    break;
                  case "Hydro":
                    return colorPalette.hydro;
                    break;
                  case "Biomass":
                    return colorPalette.biomass;
                    break;
                  case "Coal":
                    return colorPalette.coal;
                    break;
                  case "Sour Gas":
                    return colorPalette.sourGas;
                    break;
                  default:
                    colorPalette.coal;
                }//switch  
              },//getFillColor
              
              getLineColor: (d) => [14, 16, 255],
              onClick: (info) => {
                  const {coordinate, object} = info;
                  const description = `<p>Site: ${object.siteName || 'Unknown'}</p>
                                       <p>Primary Fuel: ${object.primaryFuel || 'Unknown'}</p>
                                       <p>Primary Fuel: ${object.installedCapacity || 'Unknown'}MW</p>`;

                  new maplibregl.Popup()
                      .setLngLat(coordinate)
                      .setHTML(description)
                      .addTo(map);
              },//onClick
            }//object passed to new deck.ScatterplotLayer constructor  
          );//new deck.ScatterplotLayer

          

          // Create the overlay
          const overlay = new deck.MapboxOverlay({
              layers: [layer],
          });
          map.addControl(overlay);
        });
    

        
    </script>
</body>
</html>